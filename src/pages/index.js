import Head from 'next/head'
import Image from 'next/image'
import Router from 'next/router'
import Stripe from 'stripe'

/* Create asyncronous function */

export async function getServerSideProps(context) {
  const stripe = new Stripe(process.env.STRIPE_SECRET_KEY ?? '', 
  {apiVersion: '2020-08-27'})

  const res = await stripe.prices.list({
    limit: 10,
    expand: ['data.product']
  })

  /* Set the price variable */

  const prices = res.data.filter(price => price.active)

  return {
    props: { prices }
  }
}

/* Products listed on Home screen */

export default function Home({prices}) {
  async function checkout() {
    const lineItems = [{
      price: prices[0].id,
      quantity: 1
    }]

    const res = await fetch('api/checkout', {
      method: 'POST',
      body: JSON.stringify({lineItems})
    })

    const data = await res.json()
    console.log(lineItems)
    console.log(data)
    Router.push(data.session.url)
  }

  return (

    /* Create containers */

    <div className='backgroundContainer'>
      <div className='header'><h2>Caddy's Poo Factory</h2></div>
      <Head>
        <title>Caddy's Poo Factory</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      {/* Description of the store. */}
      <p className='pooDescription'>
        All of the manure sold here is fresh from Caddy's inner factory.
        Using a recipe of Timothy Hay and pellets she creates only the highest quality manure
        or snack food for your dog!
      </p>
      <div className='productContainer'>
        <img className='pooImage' src='https://www.tdfertilizermachinery.com/wp-content/uploads/2019/04/Organic-Fertilizer-Granules-2.jpg'/>
        {prices.map((price, index) => {
        return <div className="product" key={index}>{price.product.name}</div>
        })}
        <button onClick={checkout}>Checkout</button>
      </div>
    </div>
  )
}
